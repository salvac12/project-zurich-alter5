<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analytics Dashboard - Vercel | Project ZURICH Alter5</title>
    <link rel="stylesheet" href="css/alter5-colors.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .metric-card {
            background: linear-gradient(135deg, var(--alter-blue) 0%, var(--alter-blue-dark) 100%);
        }
        .chart-container { height: 300px; }
        .notification {
            animation: slideIn 0.3s ease;
        }
        @keyframes slideIn {
            from { transform: translateY(-20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Header -->
    <header class="bg-white shadow-sm border-b border-gray-200">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center py-4">
                <div class="flex items-center">
                    <h1 class="text-2xl font-bold text-gray-900">Analytics Dashboard</h1>
                    <span class="ml-3 px-3 py-1 bg-green-100 text-green-800 text-sm font-medium rounded-full">
                        ‚úÖ Vercel Ready
                    </span>
                </div>
                <div class="flex items-center space-x-4">
                    <button id="refreshBtn" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">
                        üîÑ Actualizar
                    </button>
                    <button id="exportBtn" class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700">
                        üìä Exportar CSV
                    </button>
                </div>
            </div>
        </div>
    </header>

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Estado de conexi√≥n -->
        <div id="connectionStatus" class="mb-6 p-4 rounded-lg border-l-4">
            <div class="flex items-center">
                <div id="statusIndicator" class="w-3 h-3 rounded-full mr-3"></div>
                <span id="statusText" class="font-medium">Conectando...</span>
            </div>
        </div>

        <!-- M√©tricas principales -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <div class="metric-card text-white p-6 rounded-lg shadow">
                <h3 class="text-sm font-medium text-blue-100">Visitantes √önicos</h3>
                <p id="totalVisitors" class="text-3xl font-bold mt-2">-</p>
                <p class="text-sm text-blue-100 mt-1">Total hist√≥rico</p>
            </div>
            
            <div class="metric-card text-white p-6 rounded-lg shadow">
                <h3 class="text-sm font-medium text-blue-100">Total Descargas</h3>
                <p id="totalDownloads" class="text-3xl font-bold mt-2">-</p>
                <p class="text-sm text-blue-100 mt-1">Todos los archivos</p>
            </div>
            
            <div class="metric-card text-white p-6 rounded-lg shadow">
                <h3 class="text-sm font-medium text-blue-100">Solicitudes NDA</h3>
                <p id="totalNDAs" class="text-3xl font-bold mt-2">-</p>
                <p class="text-sm text-blue-100 mt-1">Pendientes + Firmadas</p>
            </div>
            
            <div class="metric-card text-white p-6 rounded-lg shadow">
                <h3 class="text-sm font-medium text-blue-100">Tiempo Promedio</h3>
                <p id="avgTime" class="text-3xl font-bold mt-2">-</p>
                <p class="text-sm text-blue-100 mt-1">Por sesi√≥n</p>
            </div>
        </div>

        <!-- Gr√°ficos -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
            <!-- Gr√°fico de descargas -->
            <div class="bg-white p-6 rounded-lg shadow">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">üìÅ Descargas por Tipo</h3>
                <div class="chart-container">
                    <canvas id="downloadsChart"></canvas>
                </div>
            </div>

            <!-- Gr√°fico de actividad -->
            <div class="bg-white p-6 rounded-lg shadow">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">üìà Actividad Diaria</h3>
                <div class="chart-container">
                    <canvas id="activityChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Tabla de visitantes -->
        <div class="bg-white rounded-lg shadow overflow-hidden">
            <div class="px-6 py-4 border-b border-gray-200">
                <h3 class="text-lg font-semibold text-gray-900">üë• An√°lisis Detallado por Visitante</h3>
                <p class="text-sm text-gray-500 mt-1">Datos recopilados desde el navegador y API de Vercel</p>
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-full">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Visitante</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Proyecto</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Descargas</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">NDA</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Tiempo</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">√öltima Actividad</th>
                        </tr>
                    </thead>
                    <tbody id="visitorsTableBody" class="bg-white divide-y divide-gray-200">
                        <tr>
                            <td colspan="6" class="px-6 py-8 text-center text-gray-500">
                                <div class="animate-spin w-6 h-6 border-2 border-blue-600 border-t-transparent rounded-full mx-auto mb-2"></div>
                                Cargando datos de analytics...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Log de eventos en tiempo real -->
        <div class="mt-8 bg-white rounded-lg shadow">
            <div class="px-6 py-4 border-b border-gray-200">
                <h3 class="text-lg font-semibold text-gray-900">üî¥ Eventos en Tiempo Real</h3>
                <p class="text-sm text-gray-500 mt-1">√öltimas actividades registradas</p>
            </div>
            <div class="p-6">
                <div id="eventsLog" class="space-y-3 max-h-64 overflow-y-auto">
                    <div class="text-sm text-gray-500 italic">No hay eventos recientes...</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        class VercelAnalyticsDashboard {
            constructor() {
                this.charts = {};
                this.updateInterval = null;
                this.init();
            }

            async init() {
                this.setupEventListeners();
                await this.loadDashboard();
                this.startRealTimeUpdates();
            }

            setupEventListeners() {
                document.getElementById('refreshBtn').addEventListener('click', () => {
                    this.loadDashboard();
                });

                document.getElementById('exportBtn').addEventListener('click', () => {
                    this.exportToCSV();
                });
            }

            async loadDashboard() {
                try {
                    this.updateConnectionStatus('connecting');
                    
                    // Cargar datos de API de Vercel
                    const response = await fetch('/api/analytics');
                    
                    if (response.ok) {
                        const data = await response.json();
                        this.updateConnectionStatus('connected');
                        this.populateDashboard(data);
                    } else {
                        throw new Error(`HTTP ${response.status}`);
                    }
                } catch (error) {
                    console.error('Error loading dashboard:', error);
                    this.updateConnectionStatus('error');
                    this.loadFallbackData();
                }
            }

            updateConnectionStatus(status) {
                const indicator = document.getElementById('statusIndicator');
                const text = document.getElementById('statusText');
                const container = document.getElementById('connectionStatus');

                switch (status) {
                    case 'connecting':
                        indicator.className = 'w-3 h-3 rounded-full mr-3 bg-yellow-400';
                        text.textContent = 'Conectando con API de Vercel...';
                        container.className = 'mb-6 p-4 rounded-lg border-l-4 border-yellow-400 bg-yellow-50';
                        break;
                    case 'connected':
                        indicator.className = 'w-3 h-3 rounded-full mr-3 bg-green-400';
                        text.textContent = 'Conectado a Vercel Analytics API ‚úÖ';
                        container.className = 'mb-6 p-4 rounded-lg border-l-4 border-green-400 bg-green-50';
                        break;
                    case 'error':
                        indicator.className = 'w-3 h-3 rounded-full mr-3 bg-red-400';
                        text.textContent = 'Sin conexi√≥n - Usando datos locales üì±';
                        container.className = 'mb-6 p-4 rounded-lg border-l-4 border-red-400 bg-red-50';
                        break;
                }
            }

            populateDashboard(data) {
                // Actualizar m√©tricas principales
                document.getElementById('totalVisitors').textContent = data.summary.totalVisitors;
                document.getElementById('totalDownloads').textContent = data.summary.totalDownloads;
                document.getElementById('totalNDAs').textContent = data.summary.totalNDARequests;
                document.getElementById('avgTime').textContent = this.formatTime(data.summary.avgTimeOnSite);

                // Actualizar gr√°ficos
                this.updateDownloadsChart(data.downloads);
                this.updateActivityChart(data.dailyStats);

                // Actualizar tabla de visitantes
                this.updateVisitorsTable(data.visitors);

                // Actualizar log de eventos
                this.updateEventsLog(data.recentEvents);
            }

            updateDownloadsChart(downloads) {
                const ctx = document.getElementById('downloadsChart').getContext('2d');
                
                if (this.charts.downloads) {
                    this.charts.downloads.destroy();
                }

                const labels = downloads.map(d => this.getFileTypeLabel(d.type));
                const data = downloads.map(d => d.count);
                const colors = downloads.map(d => this.getFileTypeColor(d.type));

                this.charts.downloads = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: labels,
                        datasets: [{
                            data: data,
                            backgroundColor: colors,
                            borderWidth: 2,
                            borderColor: '#fff'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: { padding: 20 }
                            }
                        }
                    }
                });
            }

            updateActivityChart(dailyStats) {
                const ctx = document.getElementById('activityChart').getContext('2d');
                
                if (this.charts.activity) {
                    this.charts.activity.destroy();
                }

                const last7Days = dailyStats.slice(-7);
                const labels = last7Days.map(stat => {
                    const date = new Date(stat.date);
                    return date.toLocaleDateString('es-ES', { month: 'short', day: 'numeric' });
                });

                this.charts.activity = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: 'Visitantes',
                                data: last7Days.map(s => s.visitors),
                                borderColor: 'var(--alter-blue)',
                                backgroundColor: 'rgba(30, 58, 138, 0.1)',
                                tension: 0.4,
                                fill: true
                            },
                            {
                                label: 'Descargas',
                                data: last7Days.map(s => s.downloads),
                                borderColor: 'var(--alter-green)',
                                backgroundColor: 'rgba(5, 150, 105, 0.1)',
                                tension: 0.4,
                                fill: false
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'top'
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
            }

            updateVisitorsTable(visitors) {
                const tbody = document.getElementById('visitorsTableBody');
                
                if (visitors.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="6" class="px-6 py-8 text-center text-gray-500">
                                No hay datos de visitantes disponibles
                            </td>
                        </tr>
                    `;
                    return;
                }

                tbody.innerHTML = visitors.map(visitor => `
                    <tr class="hover:bg-gray-50">
                        <td class="px-6 py-4">
                            <div class="text-sm font-medium text-gray-900">${visitor.name || 'Visitante An√≥nimo'}</div>
                            <div class="text-sm text-gray-500">${visitor.email}</div>
                        </td>
                        <td class="px-6 py-4">
                            <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full ${
                                visitor.project === 'senior_financing' 
                                    ? 'bg-blue-100 text-blue-800' 
                                    : 'bg-green-100 text-green-800'
                            }">
                                ${visitor.project === 'senior_financing' ? 'Senior' : 'Equity'}
                            </span>
                        </td>
                        <td class="px-6 py-4 text-sm text-gray-900">
                            üìÑ ${visitor.downloads['term-sheet'] || 0} | 
                            üìä ${visitor.downloads['teaser'] || 0} | 
                            üíº ${visitor.downloads['financial-model'] || 0}
                        </td>
                        <td class="px-6 py-4">
                            <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full ${
                                visitor.ndaStatus === 'signed' 
                                    ? 'bg-green-100 text-green-800' 
                                    : 'bg-yellow-100 text-yellow-800'
                            }">
                                ${visitor.ndaStatus === 'signed' ? '‚úÖ Firmado' : '‚è≥ Pendiente'}
                            </span>
                        </td>
                        <td class="px-6 py-4 text-sm text-gray-900">${this.formatTime(visitor.totalTime)}</td>
                        <td class="px-6 py-4 text-sm text-gray-500">${this.formatDate(visitor.lastAccess)}</td>
                    </tr>
                `).join('');
            }

            updateEventsLog(events) {
                const container = document.getElementById('eventsLog');
                
                if (events.length === 0) {
                    container.innerHTML = '<div class="text-sm text-gray-500 italic">No hay eventos recientes...</div>';
                    return;
                }

                container.innerHTML = events.map(event => `
                    <div class="notification flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                        <div class="flex items-center">
                            <span class="text-lg mr-3">${this.getEventIcon(event.type)}</span>
                            <div>
                                <div class="text-sm font-medium text-gray-900">${this.getEventDescription(event)}</div>
                                <div class="text-xs text-gray-500">${event.visitor}</div>
                            </div>
                        </div>
                        <div class="text-xs text-gray-400">${this.formatTime(new Date(event.timestamp))}</div>
                    </div>
                `).join('');
            }

            loadFallbackData() {
                // Cargar datos desde localStorage si la API falla
                const fallbackData = {
                    summary: {
                        totalVisitors: localStorage.getItem('analytics_visitors_count') || 0,
                        totalDownloads: localStorage.getItem('analytics_downloads_count') || 0,
                        totalNDARequests: localStorage.getItem('analytics_nda_count') || 0,
                        avgTimeOnSite: 180
                    },
                    downloads: [
                        { type: 'term-sheet', count: 5 },
                        { type: 'teaser', count: 8 },
                        { type: 'financial-model', count: 3 },
                        { type: 'nda', count: 2 }
                    ],
                    visitors: [],
                    recentEvents: [],
                    dailyStats: this.generateMockDailyStats()
                };

                this.populateDashboard(fallbackData);
            }

            startRealTimeUpdates() {
                // Actualizar cada 30 segundos
                this.updateInterval = setInterval(() => {
                    this.loadDashboard();
                }, 30000);
            }

            exportToCSV() {
                // Generar y descargar CSV con datos de analytics
                const csvContent = this.generateCSV();
                const blob = new Blob([csvContent], { type: 'text/csv' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `analytics_${new Date().toISOString().split('T')[0]}.csv`;
                a.click();
                window.URL.revokeObjectURL(url);
            }

            generateCSV() {
                return `Fecha,Visitantes,Descargas,NDAs
${new Date().toISOString().split('T')[0]},${document.getElementById('totalVisitors').textContent},${document.getElementById('totalDownloads').textContent},${document.getElementById('totalNDAs').textContent}`;
            }

            // Funciones auxiliares
            getFileTypeLabel(type) {
                const labels = {
                    'term-sheet': 'Term Sheet',
                    'teaser': 'Teaser',
                    'financial-model': 'Modelo Financiero',
                    'nda': 'NDA'
                };
                return labels[type] || type;
            }

            getFileTypeColor(type) {
                const colors = {
                    'term-sheet': 'var(--alter-blue)',
                    'teaser': 'var(--alter-green)',
                    'financial-model': '#f59e0b',
                    'nda': '#8b5cf6'
                };
                return colors[type] || '#6b7280';
            }

            getEventIcon(type) {
                const icons = {
                    'download': 'üì•',
                    'nda_request': 'üìã',
                    'page_visit': 'üëÅÔ∏è',
                    'click': 'üñ±Ô∏è'
                };
                return icons[type] || 'üìä';
            }

            getEventDescription(event) {
                switch (event.type) {
                    case 'download': return `Descarga: ${event.file}`;
                    case 'nda_request': return 'Solicitud de NDA';
                    case 'page_visit': return 'Visita a p√°gina';
                    default: return event.type;
                }
            }

            formatTime(seconds) {
                if (typeof seconds === 'string') {
                    return new Date(seconds).toLocaleTimeString('es-ES');
                }
                
                const mins = Math.floor(seconds / 60);
                const secs = seconds % 60;
                return `${mins}:${secs.toString().padStart(2, '0')}`;
            }

            formatDate(dateString) {
                return new Date(dateString).toLocaleString('es-ES');
            }

            generateMockDailyStats() {
                const stats = [];
                for (let i = 6; i >= 0; i--) {
                    const date = new Date();
                    date.setDate(date.getDate() - i);
                    stats.push({
                        date: date.toISOString().split('T')[0],
                        visitors: Math.floor(Math.random() * 5) + 1,
                        downloads: Math.floor(Math.random() * 8) + 2
                    });
                }
                return stats;
            }

            destroy() {
                if (this.updateInterval) {
                    clearInterval(this.updateInterval);
                }
                Object.values(this.charts).forEach(chart => {
                    if (chart) chart.destroy();
                });
            }
        }

        // Inicializar dashboard
        let dashboardInstance;
        document.addEventListener('DOMContentLoaded', function() {
            dashboardInstance = new VercelAnalyticsDashboard();
        });

        window.addEventListener('beforeunload', () => {
            if (dashboardInstance) {
                dashboardInstance.destroy();
            }
        });
    </script>
</body>
</html>